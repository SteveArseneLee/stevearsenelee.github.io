---
title:  "[Docker&Kubernetes] Container Infra Environment I"
excerpt: "Kubernetes Introduction"

categories:
  - Docker&Kubernetes
tags:
  - [Docker&Kubernetes]

toc: true
toc_sticky: true
 
date: 2021-07-07
last_modified_at: 2021-07-07
---
### run과 create
run으로 pod를 생성하면 단일 pod 1개만 생성되고 관리됨. 그리고 create deployment로 pod를 생성하면 deployment라는 관리 그룹 내에서 pod가 생성됨.

### 기본 오브젝트
- Pod : 쿠버네티스에서 실행되는 최소 단위, 즉 웹 서비스를 구동하는 데 필요한 최소 단위. 독립적인 공간과 사용 가능한 IP를 가지고 있음. 하나의 파드는 1개 이상의 컨테이너를 갖고 있기 때문에 여러 기능을 묶어 하나의 목적으로 사용할 수 있음. 그러나 범용으로 사용할땐 대부분 1개의 파드에 1개의 컨테이너를 적용
- Namespace : 쿠버네티스 클러스터에서 사용되는 리소스들을 구분해 관리하는 그룹. 특별히 지정하지 않으면 기본으로 할당되는 default, 쿠버네티스 시스템에서 사용되는 kube-system, 온프레미스에서 쿠버네티스를 사용할 경우 외부에서 쿠버네티스 클러스터 내부로 접속하게 도와주는 컨테이너들이 속해있는 metallb-system이 있음
- Volume : 파드가 생성될 때 파드에서 사용할 수 있는 디렉터리 제공. 기본적으로 파드는 영속되는 개념이 아니라 제공되는 디렉터리도 임시로 사용. 하지만 파드가 사라지더라도 저장과 보존이 가능한 디렉터리를 볼륨 오브젝트를 통해 생성하고 사용할 수 있음.
- Service : 파드는 클러스터 내에서 유동적이기 때문에 접속 정보가 고정일 수 없음. 따라서 파드 접속을 안정적으로 유지하도록 서비스를 통해 내/외부로 연결됨. 그래서 서비스는 새로 파드가 생성될 때 부여되는 새로운 IP를 기존에 제공하던 기능과 연결해줌.

### 디플로이먼트
쿠버네티스에서 가장 많이 쓰이는 디폴로이먼트 오브젝트는 파드에 기반을 두고 있으며, 레플리카셋 오브젝트를 합쳐 놓은 형태.

API 서버와 컨트롤러 매니저는 단순히 파드가 생성되는 것을 감시하는 것이 아니라 디플로이먼트처럼 레플리카셋을 포함하는 오브젝트의 생성을 감시

### 레플리카셋
레플리카셋은 파드 수를 보장하는 기능만 제공하기 때문에 롤링 업데이트 기능 등이 추가된 디플로이먼트를 사용해 파드 수를 관리하기를 권장

### 오브젝트 스펙(spec)
설정 적용할때 작성하는 파일

- YAML

Run

- 명령 실행 : 제한적
- 파일 실행 : 안 됨
- 변경 가능 : 안 됨
- 실행 편의성 : 매우 좋음
- 기능 유지 : 제한적

Create

- 명령 실행 : 가능
- 파일 실행 : 가능
- 변경 가능 : 안 됨
- 실행 편의성 : 매우 좋음
- 기능 유지 : 지원됨

Apply

- 명령 실행 : 안 됨
- 파일 실행 : 가능
- 변경 가능 : 가능
- 실행 편의성 : 좋음
- 기능 유지 : 다양하게 지원

> 파드의 자동 복구 기술 : Self-Healing
⇒ 제대로 작동하지 않는 컨테이너를 다시 시작하거나 교체해 파드가 정상적으로 작동하게 함.

<br>

> 문제가 생길 가능성이 있는 노드라고 알려주는 기능 : cordon
cordon명령을 실행하면 해당 노드에 파드가 할당되지 않게 스케줄되지 않는 상태(SchedulingDisabled)라는 표시

### 유지보수
> 쿠버네티스를 사용하다보면 노드를 꺼야하는 상황이 발생 : drain

- kubectl drain 명령을 실행해 유지보수할 노드를 파드가 없는 상태로 만듬. 이때 명령을 실행하면 노드에서 데몬셋을 지울 수 없어서 명령을 수행할 수 없다고 나옴
    - drain은 실제로 파드를 옮기는게 아니라 노드에서 파드를 삭제하고 다른 곳에 다시 생성
    - DaemonSet은 각 노드에 1개만 존재하는 파드라서 drain으로는 삭제할 수 없음.
- 따라서 drain 명령을 실행할 때는 ```ignore-daemonsets``` 옵션 함께 사용

### 파드 업데이트 및 복구
> --record 옵션 사용

```docker
kubectl rollout history deployment rollouy-nginx
```

- record 옵션으로 기록된 히스토리는 rollout history 명령을 실행해 확인 가능
- rollout실행 시 파드들의 이름과 IP가 변경되는데 이는 시스템의 영향을 최소화하기 위해 replicas에 속한 파드를 모두 한 번에 지우는 것이 아니라 파드를 하나씩 순차적으로 생성되는 과정에서 파드 수가 많으면 하나씩이 아니라 다수의 파드가 업데이트되기 때문

### 업데이트 실패 시 파드 복구하기
> set image

- 책 내용의 set image를 하면 파드가 삭제되지 않고 pending 상태에서 넘어가지 않음. 그 이유는 replicas가 새로 생성되는 과정에서 멈추는데 이는 내가 지정한 버전의 컨테이너가 없기 때문. 따라서 replicas가 생성을 시도했으나 컨테이너 이미지를 찾을 수 없어서 디플로이먼트가 배포되지 않음. 이를 방지하고자 업데이트할 때 rollout을 사용하고 --record로 기록함

### 특정 시점으로 파드 복구
> --to-revision
<!doctype html><html lang=ko dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Producer Acks, Batch, Page Cache and Flush
  #

acks 설정은 요청이 성공할 때를 정의하는 데 사용되는 Producer에 설정하는 Parameter"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="http://stevearsenelee.iptime.org/docs/observability/metrics/prom-test/"><meta property="og:site_name" content="LogLee's Training Ground"><meta property="og:title" content="Prom"><meta property="og:description" content="Producer Acks, Batch, Page Cache and Flush # acks 설정은 요청이 성공할 때를 정의하는 데 사용되는 Producer에 설정하는 Parameter"><meta property="og:locale" content="ko"><meta property="og:type" content="article"><meta property="article:section" content="docs"><title>Prom | LogLee's Training Ground</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=http://stevearsenelee.iptime.org/docs/observability/metrics/prom-test/><link rel=stylesheet href=/book.min.e9f68c3fff3d8236a489d16a9caf6de5e4d1a29c20eb4b5524e42cd30be4d319.css integrity="sha256-6faMP/89gjakidFqnK9t5eTRopwg60tVJOQs0wvk0xk=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/kr.search.min.7519638bba906ebd7144ec6f10865974a0bf0a20eaf199bab28b9c08e4017da1.js integrity="sha256-dRlji7qQbr1xROxvEIZZdKC/CiDq8Zm6soucCOQBfaE=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>LogLee's Training Ground</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder aria-label maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-ca170abdbca9581a14670b9cae3bc610 class=toggle>
<label for=section-ca170abdbca9581a14670b9cae3bc610 class="flex justify-between"><a href=/docs/infra/>Infra</a></label><ul><li><input type=checkbox id=section-13e9d5199e5227e2fc9d2761cefce5e3 class=toggle>
<label for=section-13e9d5199e5227e2fc9d2761cefce5e3 class="flex justify-between"><a href=/docs/infra/kvm/>KVM</a></label><ul></ul></li><li><input type=checkbox id=section-f81e017d773579a54933834beb44e810 class=toggle>
<label for=section-f81e017d773579a54933834beb44e810 class="flex justify-between"><a href=/docs/infra/kubernetes/>Kubernetes</a></label><ul></ul></li></ul></li><li><input type=checkbox id=section-0a6b727fd0c16fe1cd97268a7c41867f class=toggle>
<label for=section-0a6b727fd0c16fe1cd97268a7c41867f class="flex justify-between"><a href=/docs/data-engineering/>Data Engineering</a></label><ul><li><input type=checkbox id=section-62b47f208465b78efb2357a9cd3b2079 class=toggle>
<label for=section-62b47f208465b78efb2357a9cd3b2079 class="flex justify-between"><a href=/docs/data-engineering/hadoop/>Hadoop</a></label><ul></ul></li><li><input type=checkbox id=section-78a946129d8f80712a11a39c8d6ebd9d class=toggle>
<label for=section-78a946129d8f80712a11a39c8d6ebd9d class="flex justify-between"><a href=/docs/data-engineering/modeling/>Modeling</a></label><ul></ul></li></ul></li><li><input type=checkbox id=section-f63bbdf8b75866dade3fafe4e1a0afff class=toggle>
<label for=section-f63bbdf8b75866dade3fafe4e1a0afff class="flex justify-between"><a href=/docs/data-integration/>Data Integration</a></label><ul><li><input type=checkbox id=section-79a0757d1ed364d3305442eeb8973397 class=toggle>
<label for=section-79a0757d1ed364d3305442eeb8973397 class="flex justify-between"><a href=/docs/data-integration/kafka/>Kafka</a></label><ul></ul></li></ul></li><li><input type=checkbox id=section-6112d994a830508704e67b42557ab468 class=toggle>
<label for=section-6112d994a830508704e67b42557ab468 class="flex justify-between"><a href=/docs/data-lake-platform/>Data Lake Platform</a></label><ul><li><input type=checkbox id=section-da639d08c72951def4c9aaca8e9ac1d2 class=toggle>
<label for=section-da639d08c72951def4c9aaca8e9ac1d2 class="flex justify-between"><a href=/docs/data-lake-platform/ceph/>Ceph</a></label><ul></ul></li></ul></li><li><input type=checkbox id=section-7943913a8058166e2057e211419337f8 class=toggle>
<label for=section-7943913a8058166e2057e211419337f8 class="flex justify-between"><a href=/docs/data-processing/>Data Processing</a></label><ul><li><input type=checkbox id=section-b4d28add6c8591349850bd55ed89041a class=toggle>
<label for=section-b4d28add6c8591349850bd55ed89041a class="flex justify-between"><a href=/docs/data-processing/flink/>Flink</a></label><ul></ul></li></ul></li><li><input type=checkbox id=section-780e6985e21edbc7ed69c6dc3b8333e0 class=toggle>
<label for=section-780e6985e21edbc7ed69c6dc3b8333e0 class="flex justify-between"><a href=/docs/language/>Language</a></label><ul></ul></li><li><input type=checkbox id=section-fff819996f2500b94ce5cef541863bca class=toggle checked>
<label for=section-fff819996f2500b94ce5cef541863bca class="flex justify-between"><a href=/docs/observability/>Observability</a></label><ul><li><input type=checkbox id=section-7cc725eebd25c7e9d47ee7960b4ecfc1 class=toggle>
<label for=section-7cc725eebd25c7e9d47ee7960b4ecfc1 class="flex justify-between"><a href=/docs/observability/logs/>Logs</a></label><ul></ul></li><li><input type=checkbox id=section-e29f94eb5bd9d5aafdffbdb564e4bea2 class=toggle checked>
<label for=section-e29f94eb5bd9d5aafdffbdb564e4bea2 class="flex justify-between"><a href=/docs/observability/metrics/>Metrics</a></label><ul></ul></li><li><input type=checkbox id=section-8d1e9a9d4e5f691b5d7e5e80cf6ef1d7 class=toggle>
<label for=section-8d1e9a9d4e5f691b5d7e5e80cf6ef1d7 class="flex justify-between"><a href=/docs/observability/traces/>Traces</a></label><ul></ul></li></ul></li><li><input type=checkbox id=section-9105c59ef39a7595ef99c4bfb78bb81e class=toggle>
<label for=section-9105c59ef39a7595ef99c4bfb78bb81e class="flex justify-between"><a href=/docs/others/>Others</a></label><ul></ul></li><li><input type=checkbox id=section-6f49c67d25efc699d81e35c4fafa9a01 class=toggle>
<label for=section-6f49c67d25efc699d81e35c4fafa9a01 class="flex justify-between"><a href=/docs/%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98/>알고리즘</a></label><ul><li><input type=checkbox id=section-5b975705a333872de85a03a37b55295c class=toggle>
<label for=section-5b975705a333872de85a03a37b55295c class="flex justify-between"><a href=/docs/%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98/a-really-important/>a-really-important</a></label><ul></ul></li><li><input type=checkbox id=section-bc87be8373f3bf11211d5856ffcb8b9c class=toggle>
<label for=section-bc87be8373f3bf11211d5856ffcb8b9c class="flex justify-between"><a href=/docs/%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98/dp/>dp</a></label><ul></ul></li><li><input type=checkbox id=section-9722cc6c30ec4fb4be66597512cf805b class=toggle>
<label for=section-9722cc6c30ec4fb4be66597512cf805b class="flex justify-between"><a href=/docs/%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98/sorting/>sorting</a></label><ul></ul></li><li><input type=checkbox id=section-9b372b33221da2f276463adf685c1ac7 class=toggle>
<label for=section-9b372b33221da2f276463adf685c1ac7 class="flex justify-between"><a href=/docs/%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98/%EC%99%84%EC%A0%84%ED%83%90%EC%83%89/>완전탐색</a></label><ul></ul></li></ul></li><li><input type=checkbox id=section-5df15e14c1b4d2a21c95dbe819a034ac class=toggle>
<label for=section-5df15e14c1b4d2a21c95dbe819a034ac class="flex justify-between"><a href=/docs/%EC%BB%B4%ED%93%A8%ED%84%B0%EC%9D%B4%EB%A1%A0/>컴퓨터이론</a></label><ul><li><input type=checkbox id=section-a39ce00a2c75f70172122b9e0fb44a67 class=toggle>
<label for=section-a39ce00a2c75f70172122b9e0fb44a67 class="flex justify-between"><a href=/docs/%EC%BB%B4%ED%93%A8%ED%84%B0%EC%9D%B4%EB%A1%A0/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC/>네트워크</a></label><ul></ul></li><li><input type=checkbox id=section-c3f58ce2e6e6f04354d15dc321113ad4 class=toggle>
<label for=section-c3f58ce2e6e6f04354d15dc321113ad4 class="flex justify-between"><a href=/docs/%EC%BB%B4%ED%93%A8%ED%84%B0%EC%9D%B4%EB%A1%A0/%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4/>데이터베이스</a></label><ul></ul></li><li><input type=checkbox id=section-a403b7d929a2700223698cf777076568 class=toggle>
<label for=section-a403b7d929a2700223698cf777076568 class="flex justify-between"><a href=/docs/%EC%BB%B4%ED%93%A8%ED%84%B0%EC%9D%B4%EB%A1%A0/%EB%94%94%EC%9E%90%EC%9D%B8%ED%8C%A8%ED%84%B4/>디자인패턴</a></label><ul></ul></li><li><input type=checkbox id=section-9c330bb0bf0f92f36cdb9d9a9d87c80a class=toggle>
<label for=section-9c330bb0bf0f92f36cdb9d9a9d87c80a class="flex justify-between"><a href=/docs/%EC%BB%B4%ED%93%A8%ED%84%B0%EC%9D%B4%EB%A1%A0/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C/>운영체제</a></label><ul></ul></li><li><input type=checkbox id=section-d088173a2cae9127fdb45d64257adb52 class=toggle>
<label for=section-d088173a2cae9127fdb45d64257adb52 class="flex justify-between"><a href=/docs/%EC%BB%B4%ED%93%A8%ED%84%B0%EC%9D%B4%EB%A1%A0/%EC%9E%90%EB%A3%8C%EA%B5%AC%EC%A1%B0/>자료구조</a></label><ul></ul></li></ul></li><li><input type=checkbox id=section-a99d37744fc4a13077658ecab17cfde2 class=toggle>
<label for=section-a99d37744fc4a13077658ecab17cfde2 class="flex justify-between"><a href=/docs/%ED%8A%B8%EB%9F%AC%EB%B8%94%EC%8A%88%ED%8C%85/>트러블슈팅</a></label><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Prom</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#producer-acks-batch-page-cache-and-flush>Producer Acks, Batch, Page Cache and Flush</a><ul><li><a href=#producer-retry>Producer Retry</a></li><li><a href=#producer-batch-처리>Producer Batch 처리</a></li><li><a href=#page-cache와-flush>Page Cache와 Flush</a></li></ul></li><li><a href=#replica-failure>Replica Failure</a></li><li><a href=#replica-recovery>Replica Recovery</a></li><li><a href=#consumer-rebalance>Consumer Rebalance</a></li><li><a href=#partition-assignment-strategy>Partition Assignment Strategy</a></li><li><a href=#cooperative-sticky-assignor>Cooperative Sticky Assignor</a></li><li><a href=#kafka-log-file>Kafka Log File</a></li><li><a href=#log-retention-and-cleanup-policy>Log Retention and Cleanup Policy</a></li><li><a href=#exactly-once-semanticseos>Exactly Once Semantics(EOS)</a></li></ul></nav></aside></header><article class="markdown book-article"><h2 id=producer-acks-batch-page-cache-and-flush>Producer Acks, Batch, Page Cache and Flush
<a class=anchor href=#producer-acks-batch-page-cache-and-flush>#</a></h2><p>acks 설정은 요청이 성공할 때를 정의하는 데 사용되는 <strong>Producer</strong>에 설정하는 Parameter</p><ul><li><code>acks=0</code> : ack가 필요하지 않음. 이 수준은 자주 사용되지 않음. 메시지 손실이 다소 있더라도 빠르게 메시지를 보내야 하는 경우에 사용된다.</li><li><code>acks=1(default)</code> : Leader가 메시지를 수신하면 ack를 보냄. Leader가 Producer에게
ACK를 보낸 후, Follower가 복제하기념전에 Leader에 장애가 발생하면 메시지가 손실. <em>“At most
once(최대 한 번)”</em> 전송을 보장</li><li><code>acks=-1(acks=all)</code> : 메시지가 Leader가 모든 Replica까지 Commit 되면 ack를 보냄
Leader를 잃어도 데이터가 살아남을 수 있도록 보장. 그러나 대기 시간이 더 길고 특정 실패
사례에서 반복되는 데이터 발생 가능성 있음. <em>“At least once(최소 한 번)”</em> 전송을 보장</li></ul><h3 id=producer-retry>Producer Retry
<a class=anchor href=#producer-retry>#</a></h3><p>retry와 관련된 Parameters:</p><table><thead><tr><th>Parameter</th><th>설명</th><th>Default 값</th></tr></thead><tbody><tr><td>retries</td><td>메세지를 send하기 위해 재시도하는 횟수</td><td>MAX_INT</td></tr><tr><td>retry.backoff.ms</td><td>재시도 사이에 추가되는 대기 시간</td><td>100</td></tr><tr><td>request.timeout.ms</td><td>Producer가 응답을 기다리는 최대 시간</td><td>30,000(30초)</td></tr><tr><td>delivery.timeout.ms</td><td>send() 후 성공 또는 실패를 보고하는 시간의 상한</td><td>120,000(2분)</td></tr><tr><td>=> retries를 조정하는 대신 <strong>delivery.timeout.ms</strong> 조정으로 retries 제어</td><td></td><td></td></tr></tbody></table><h3 id=producer-batch-처리>Producer Batch 처리
<a class=anchor href=#producer-batch-%ec%b2%98%eb%a6%ac>#</a></h3><ul><li>메시지를 모아서 한번에 전송</li><li>Batch 처리는 RPC(Remote Procedure Call)수를 줄여서 Broker가 처리하는 작업이 줄어들기
때문에 더 나은 처리량을 제공</li><li><code>linger.ms</code> : (default : 0). 메시지가 함께 Batch 처리될 때까지 대기 시간</li><li><code>batch.size</code> : (default : 16KB). 보내기 전 Batch의 최대 크기</li></ul><blockquote><p>Batch 처리의 일반적인 설정은 linger.ms=100 및 batch.size=1000000</p></blockquote><h3 id=page-cache와-flush>Page Cache와 Flush
<a class=anchor href=#page-cache%ec%99%80-flush>#</a></h3><ul><li>메시지는 Partition에 기록됨</li><li>Partition은 Log Segment file로 구성 (기본값 : 1GB마다 새로운 Segment 생성)</li><li>성능을 위해 Log Segment는 OS Page Cache에 기록됨</li><li>로그 파일에 저장된 메시지의 데이터 형식은 Broker가 Producer로부터 수신한 것, 그리고 Consumer에게 보내는 것과 정확히 동일하므로, Zero-Copy(Zero-copy 전송은 데이터가, User Space에 복사되지 않고, CPU 개입 없이 Page Cache와 Network Buffer 사이에서 직접 전송되는 것을 의미. 이것을 통해 Broker Heap 메모리를 절약하고 또한 엄청난 처리량을 제공)가 가능</li><li>Page Cache는 다음과 같은 경우 디스크로 Flush됨<ul><li>Broker가 완전히 종료</li><li>OS background “Flusher Thread” 실행</li></ul></li></ul><h4 id=flush-전에-broker-장애가-발생하면>Flush 전에 Broker 장애가 발생하면&mldr;
<a class=anchor href=#flush-%ec%a0%84%ec%97%90-broker-%ec%9e%a5%ec%95%a0%ea%b0%80-%eb%b0%9c%ec%83%9d%ed%95%98%eb%a9%b4>#</a></h4><ul><li>OS가 데이터를 디스크로 flush하기 전 broker의 시스템에 장애가 발생하면 해당 데이터가 손실됨</li><li>Partition이 Replication되어 있다면, Broker가 다시 온라인 상태가 되면 필요시 Leader Replica에서 데이터가 복구됨</li><li>Replication이 없다면, 데이터는 영구적 손실 가능</li></ul><h4 id=kafka-자체-flush-정책>Kafka 자체 Flush 정책
<a class=anchor href=#kafka-%ec%9e%90%ec%b2%b4-flush-%ec%a0%95%ec%b1%85>#</a></h4><ul><li>마지막 Flush 이후의 메시지 수(<span style=color:red>log.flush.interval.messages</span>) 또는 시간(<span style=color:red>log.flush.interval.ms</span>)으로 Flush(fsync)를 트리거하도록 설정할 수 있음</li><li>Kafka는 운영 체제의 background Flush 기능(예: pdflush)을 더 효율적으로 허용하는 것을
선호하기 때문에 이러한 설정은 기본적으로 무한(기본적으로 fsync 비활성화)으로 설정</li><li>이러한 설정을 기본값으로 유지하는 것을 권장</li><li>*.log 파일을 보면 디스크로 Flush된 데이터와 아직 Flush되지 않은 Page Cache (OS
Buffer)에 있는 데이터가 모두 표시됨</li><li>Flush된 항목과 Flush되지 않은 항목을 표시하는 Linux 도구(예: vmtouch)도 있음</li></ul><h2 id=replica-failure>Replica Failure
<a class=anchor href=#replica-failure>#</a></h2><h2 id=replica-recovery>Replica Recovery
<a class=anchor href=#replica-recovery>#</a></h2><h2 id=consumer-rebalance>Consumer Rebalance
<a class=anchor href=#consumer-rebalance>#</a></h2><h2 id=partition-assignment-strategy>Partition Assignment Strategy
<a class=anchor href=#partition-assignment-strategy>#</a></h2><h2 id=cooperative-sticky-assignor>Cooperative Sticky Assignor
<a class=anchor href=#cooperative-sticky-assignor>#</a></h2><h2 id=kafka-log-file>Kafka Log File
<a class=anchor href=#kafka-log-file>#</a></h2><h2 id=log-retention-and-cleanup-policy>Log Retention and Cleanup Policy
<a class=anchor href=#log-retention-and-cleanup-policy>#</a></h2><h2 id=exactly-once-semanticseos>Exactly Once Semantics(EOS)
<a class=anchor href=#exactly-once-semanticseos>#</a></h2></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#producer-acks-batch-page-cache-and-flush>Producer Acks, Batch, Page Cache and Flush</a><ul><li><a href=#producer-retry>Producer Retry</a></li><li><a href=#producer-batch-처리>Producer Batch 처리</a></li><li><a href=#page-cache와-flush>Page Cache와 Flush</a></li></ul></li><li><a href=#replica-failure>Replica Failure</a></li><li><a href=#replica-recovery>Replica Recovery</a></li><li><a href=#consumer-rebalance>Consumer Rebalance</a></li><li><a href=#partition-assignment-strategy>Partition Assignment Strategy</a></li><li><a href=#cooperative-sticky-assignor>Cooperative Sticky Assignor</a></li><li><a href=#kafka-log-file>Kafka Log File</a></li><li><a href=#log-retention-and-cleanup-policy>Log Retention and Cleanup Policy</a></li><li><a href=#exactly-once-semanticseos>Exactly Once Semantics(EOS)</a></li></ul></nav></div></aside></main></body></html>